```html
<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Alta Patrimonial</title>
  <meta name="description" content="An√°lise patrimonial: constru√ß√£o e sustenta√ß√£o. Simule cen√°rios e entenda a sa√∫de do seu patrim√¥nio." />
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&display=swap" rel="stylesheet">
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.3"></script>
  <style>
    :root{ --bg:#F7F8F6; --ink:#141414; --line:rgba(20,20,20,.10); --green:#1F4D3A; }
    html,body{ font-family: Inter, system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; }
    .shadow-soft{ box-shadow: 0 8px 30px rgba(0,0,0,.06); }
    .focus-ring:focus{ outline:none; box-shadow: 0 0 0 4px rgba(31,77,58,.12); border-color: rgba(20,20,20,.25); }
    .pill{ border:1px solid var(--line); background: rgba(247,248,246,.85); }
  </style>
</head>

<body class="bg-[var(--bg)] text-[var(--ink)]">
  <header class="sticky top-0 z-20 border-b border-black/5 bg-[var(--bg)]/80 backdrop-blur">
    <div class="mx-auto max-w-6xl px-5 py-4 flex items-center justify-between">
      <div class="text-[15px] font-semibold tracking-wide">Alta Patrimonial</div>
      <div class="hidden md:flex items-center gap-6 text-[13px] text-black/60">
        <a href="#privacidade" class="hover:text-black">Privacidade</a>
      </div>
    </div>
  </header>

  <main class="mx-auto max-w-6xl px-5 py-10">
    <div class="mb-7">
      <div class="text-[13px] font-medium text-black/55">An√°lise patrimonial</div>
      <h1 class="mt-2 text-2xl md:text-3xl font-semibold leading-tight">
        Diagn√≥stico simples: seu plano √© sustent√°vel?
      </h1>
      <p class="mt-2 text-[13px] text-black/55 max-w-3xl leading-relaxed">
        Voc√™ escolhe o cen√°rio (<b>Constru√ß√£o</b> ou <b>Sustenta√ß√£o</b>). O retorno base e as faixas
        <b>Conservador/Base/Otimista</b> s√£o configur√°veis por voc√™. A infla√ß√£o √© opcional e usada apenas como compara√ß√£o.
      </p>

      <div class="mt-5 inline-flex rounded-xl border border-black/10 bg-white p-1 shadow-sm">
        <button id="btnBuild" class="rounded-lg px-4 py-2 text-[13px] font-medium transition text-black/70 hover:bg-black/5">
          Constru√ß√£o
        </button>
        <button id="btnSustain" class="rounded-lg px-4 py-2 text-[13px] font-medium transition bg-[var(--green)] text-white">
          Sustenta√ß√£o
        </button>
      </div>
    </div>

    <div class="grid gap-6 md:grid-cols-5">
      <!-- Inputs -->
      <section class="md:col-span-2">
        <div class="rounded-2xl border border-black/10 bg-white p-5 shadow-soft">
          <div class="mb-4 text-[13px] font-semibold text-black/70">Par√¢metros</div>

          <div class="space-y-4">
            <div>
              <label class="mb-1 block text-[12px] font-medium text-black/60">Patrim√¥nio atual</label>
              <input id="P0" class="h-[42px] w-full rounded-xl border border-black/10 bg-white px-3 text-[13px] transition focus-ring"
                     placeholder="Ex.: 16000000" />
              <div class="mt-1 text-[12px] text-black/45">Digite s√≥ n√∫meros (ex.: 16000000). Formata automaticamente.</div>
            </div>

            <div class="grid grid-cols-3 gap-3">
              <div class="col-span-2">
                <label id="cfLabel" class="mb-1 block text-[12px] font-medium text-black/60">Retirada</label>
                <input id="CF" class="h-[42px] w-full rounded-xl border border-black/10 bg-white px-3 text-[13px] transition focus-ring"
                       placeholder="Ex.: 80000" />
              </div>
              <div class="col-span-1">
                <label class="mb-1 block text-[12px] font-medium text-black/60">Periodicidade</label>
                <select id="CFPeriod" class="h-[42px] w-full rounded-xl border border-black/10 bg-white px-3 text-[13px] transition focus-ring">
                  <option value="mensal" selected>Mensal</option>
                  <option value="anual">Anual</option>
                </select>
              </div>
            </div>

            <!-- Step-up (sustain only) -->
            <div id="StepFields" class="grid grid-cols-2 gap-3">
              <div>
                <label class="mb-1 block text-[12px] font-medium text-black/60">Retirada mensal no 2¬∫ ano (opcional)</label>
                <input id="CFY2" class="h-[42px] w-full rounded-xl border border-black/10 bg-white px-3 text-[13px] transition focus-ring"
                       placeholder="Ex.: 100000" />
              </div>
              <div>
                <label class="mb-1 block text-[12px] font-medium text-black/60">Retirada mensal no 3¬∫ ano (opcional)</label>
                <input id="CFY3" class="h-[42px] w-full rounded-xl border border-black/10 bg-white px-3 text-[13px] transition focus-ring"
                       placeholder="Ex.: 120000" />
              </div>
            </div>

            <div>
              <label class="mb-1 block text-[12px] font-medium text-black/60">Horizonte (anos)</label>
              <input id="Years" type="number" min="1" max="40"
                     class="h-[42px] w-full rounded-xl border border-black/10 bg-white px-3 text-[13px] transition focus-ring"
                     placeholder="Ex.: 20" />
            </div>

            <!-- Returns: fully user-configurable -->
            <div class="rounded-2xl border border-black/10 bg-[var(--bg)] p-4">
              <div class="text-[13px] font-semibold text-black/70">Cen√°rios de retorno (% a.a.)</div>
              <div class="mt-2 grid grid-cols-3 gap-3">
                <div>
                  <label class="mb-1 block text-[12px] font-medium text-black/60">Conservador</label>
                  <input id="Rcons" class="h-[42px] w-full rounded-xl border border-black/10 bg-white px-3 text-[13px] transition focus-ring"
                         placeholder="Ex.: 8" />
                </div>
                <div>
                  <label class="mb-1 block text-[12px] font-medium text-black/60">Base</label>
                  <input id="Rbase" class="h-[42px] w-full rounded-xl border border-black/10 bg-white px-3 text-[13px] transition focus-ring"
                         placeholder="Ex.: 12" />
                </div>
                <div>
                  <label class="mb-1 block text-[12px] font-medium text-black/60">Otimista</label>
                  <input id="Ropt" class="h-[42px] w-full rounded-xl border border-black/10 bg-white px-3 text-[13px] transition focus-ring"
                         placeholder="Ex.: 14" />
                </div>
              </div>
              <div class="mt-2 text-[12px] text-black/45">
                Voc√™ define os 3 retornos. O c√°lculo converte para taxa mensal equivalente automaticamente.
              </div>
            </div>

            <!-- Inflation comparison (optional, blank by default) -->
            <details class="rounded-xl border border-black/10 bg-white p-4">
              <summary class="cursor-pointer text-[13px] font-semibold text-black/70">Comparar com infla√ß√£o (opcional)</summary>
              <div class="mt-3 grid grid-cols-2 gap-3">
                <div>
                  <label class="mb-1 block text-[12px] font-medium text-black/60">Infla√ß√£o de refer√™ncia (% a.a.)</label>
                  <input id="InflRef" class="h-[42px] w-full rounded-xl border border-black/10 bg-white px-3 text-[13px] transition focus-ring"
                         placeholder="Ex.: 4" />
                  <div class="mt-1 text-[12px] text-black/45">Usada s√≥ para comparar poder de compra.</div>
                </div>
                <div class="flex items-end">
                  <label class="flex h-[42px] w-full cursor-pointer items-center justify-between rounded-xl border border-black/10 bg-white px-3 text-[13px]">
                    <span class="text-black/70">Mostrar linha infla√ß√£o</span>
                    <input id="ShowInfl" type="checkbox" class="h-4 w-4 accent-[var(--green)]" checked />
                  </label>
                </div>
              </div>
            </details>

            <button id="Run"
              class="mt-1 w-full rounded-xl bg-[var(--green)] px-4 py-3 text-[13px] font-semibold text-white transition hover:brightness-110">
              Analisar cen√°rio
            </button>

            <div class="pt-1 text-[12px] text-black/45">
              C√°lculo mensal (rende ‚Üí aplica retirada/aporte). A infla√ß√£o (se preenchida) serve apenas para compara√ß√£o.
            </div>
          </div>
        </div>

        <div id="privacidade" class="mt-4 rounded-2xl border border-black/10 bg-white p-5 shadow-soft">
          <div class="text-[13px] font-semibold text-black/70">Privacidade</div>
          <div class="mt-2 text-[12px] leading-relaxed text-black/55">
            A an√°lise roda no seu navegador. Nenhum dado precisa ser armazenado para usar o simulador.
          </div>
        </div>
      </section>

      <!-- Results -->
      <section class="md:col-span-3">
        <div class="rounded-2xl border border-black/10 bg-white p-5 shadow-soft">
          <div class="flex items-start justify-between gap-4">
            <div>
              <div class="text-[13px] font-semibold text-black/70">Resultado</div>
              <div class="mt-2 flex items-center gap-3">
                <div id="HealthEmoji" class="text-2xl font-semibold">‚Äî</div>
                <div>
                  <div id="HealthTitle" class="text-[13px] font-semibold">Aguardando an√°lise</div>
                  <div id="HealthDesc" class="text-[12px] text-black/55">Preencha os campos e clique em ‚ÄúAnalisar cen√°rio‚Äù.</div>
                </div>
              </div>
            </div>

            <div class="relative">
              <button id="SaveBtn" disabled
                class="rounded-xl border border-black/5 bg-black/5 px-3 py-2 text-[13px] font-medium text-black/30 cursor-not-allowed">
                Salvar an√°lise
              </button>
              <div id="SaveBox" class="hidden absolute right-0 top-11 w-[320px] rounded-2xl border border-black/10 bg-white p-4 shadow-soft">
                <div class="text-[13px] font-semibold">Enviar por e-mail</div>
                <div class="mt-1 text-[12px] text-black/55">Voc√™ receber√° um resumo do cen√°rio (MVP).</div>
                <form id="SaveForm" class="mt-3 space-y-3">
                  <input id="Email" type="email" required placeholder="seuemail@dominio.com"
                    class="h-[42px] w-full rounded-xl border border-black/10 px-3 text-[13px] transition focus-ring" />
                  <button type="submit"
                    class="w-full rounded-xl bg-[var(--green)] px-4 py-2.5 text-[13px] font-semibold text-white transition hover:brightness-110">
                    Enviar resumo
                  </button>
                </form>
              </div>
            </div>
          </div>

          <div class="mt-5 grid gap-3 md:grid-cols-3">
            <div class="rounded-2xl border border-black/10 bg-white p-4">
              <div id="Metric1Title" class="text-[12px] font-medium text-black/55">Taxa de retirada (inicial)</div>
              <div id="Metric1Value" class="mt-2 text-[18px] font-semibold">‚Äî</div>
              <div id="Metric1Sub" class="mt-1 text-[12px] text-black/40">Retirada anual / patrim√¥nio</div>
            </div>
            <div class="rounded-2xl border border-black/10 bg-white p-4">
              <div class="text-[12px] font-medium text-black/55">Horizonte analisado</div>
              <div id="Metric2Value" class="mt-2 text-[18px] font-semibold">‚Äî</div>
              <div class="mt-1 text-[12px] text-black/40">Definido por voc√™</div>
            </div>
            <div class="rounded-2xl border border-black/10 bg-white p-4">
              <div id="Metric3Title" class="text-[12px] font-medium text-black/55">Esgotamento (base)</div>
              <div id="Metric3Value" class="mt-2 text-[18px] font-semibold">‚Äî</div>
              <div id="Metric3Sub" class="mt-1 text-[12px] text-black/40">Se ocorrer no horizonte</div>
            </div>
          </div>

          <div id="InflBlock" class="mt-4 hidden rounded-xl border border-black/10 bg-[var(--bg)] p-4">
            <div class="flex flex-wrap items-center gap-2">
              <span class="pill rounded-full px-3 py-1 text-[12px] text-black/70">
                Infla√ß√£o refer√™ncia: <b id="InflRefTag">‚Äî</b>
              </span>
              <span class="pill rounded-full px-3 py-1 text-[12px] text-black/70">
                M√≠nimo p/ manter poder de compra (ano final): <b id="InflLineFinal">‚Äî</b>
              </span>
              <span class="pill rounded-full px-3 py-1 text-[12px] text-black/70">
                Patrim√¥nio ‚Äúreal‚Äù (ano final): <b id="RealFinal">‚Äî</b>
              </span>
            </div>
            <div class="mt-2 text-[12px] text-black/55">
              Compara√ß√£o opcional (n√£o altera o c√°lculo). Serve para enxergar poder de compra.
            </div>
          </div>

          <div id="Why" class="mt-4 rounded-xl border border-black/10 bg-[var(--bg)] p-4 text-[13px] leading-relaxed text-black/70">
            Assim que voc√™ rodar a an√°lise, aqui aparece a explica√ß√£o do cen√°rio.
          </div>

          <details class="mt-3 rounded-xl border border-black/10 bg-white p-4">
            <summary class="cursor-pointer text-[13px] font-semibold text-black/70">Como calculamos (simples)</summary>
            <div id="How" class="mt-2 text-[12px] leading-relaxed text-black/60">‚Äî</div>
          </details>

          <div class="mt-5 rounded-2xl border border-black/10 bg-white p-3">
            <div class="flex items-center justify-between px-2 pb-2">
              <div class="text-[13px] font-semibold text-black/70">Evolu√ß√£o do patrim√¥nio (nominal)</div>
              <div class="text-[12px] text-black/45">Conservador ‚Ä¢ Base ‚Ä¢ Otimista</div>
            </div>
            <div class="h-[280px]">
              <canvas id="Chart"></canvas>
            </div>
          </div>

          <div class="mt-5 overflow-hidden rounded-2xl border border-black/10">
            <div class="bg-white px-4 py-3 text-[13px] font-semibold text-black/70">Ano a ano (base) + indicador</div>
            <div class="max-h-[320px] overflow-auto bg-white">
              <table class="w-full border-collapse text-left text-[13px]">
                <thead class="sticky top-0 bg-white">
                <tr class="border-b border-black/10 text-black/55">
                  <th class="px-4 py-2 font-medium">Ano</th>
                  <th class="px-4 py-2 font-medium">Patrim√¥nio (base)</th>
                  <th id="TableCFHead" class="px-4 py-2 font-medium">Retirada</th>
                  <th class="px-4 py-2 font-medium">Sa√∫de</th>
                </tr>
                </thead>
                <tbody id="TableBody">
                  <tr><td class="px-4 py-6 text-black/45" colspan="4">Rode uma an√°lise para ver a tabela.</td></tr>
                </tbody>
              </table>
            </div>
          </div>

          <div class="mt-4 text-[12px] text-black/45">Nota: esta ferramenta n√£o constitui recomenda√ß√£o de investimentos.</div>
        </div>
      </section>
    </div>
  </main>

<script>
  const $ = (id) => document.getElementById(id);

  function clamp(n,min,max){ return Math.max(min, Math.min(max,n)); }
  function fmtBRL(n){ return Number.isFinite(n) ? n.toLocaleString("pt-BR",{style:"currency",currency:"BRL"}) : "‚Äî"; }
  function fmtPct(dec){ return Number.isFinite(dec) ? (dec*100).toLocaleString("pt-BR",{maximumFractionDigits:2}) + "%" : "‚Äî"; }
  function annualToMonthlyEq(rateAnnualDec){ return Math.pow(1 + rateAnnualDec, 1/12) - 1; }

  // Percent parsing
  function parseNumberBR(v){
    const s = String(v || "").trim().replace(",", ".").replace(/[^\d.-]/g,"");
    const n = Number(s);
    return Number.isFinite(n) ? n : NaN;
  }

  // BRL mask
  function onlyDigits(s){ return (s || "").replace(/\D/g, ""); }
  function formatBRLFromDigits(digits){
    const n = Number(digits || "0") / 100;
    return n.toLocaleString("pt-BR", { style:"currency", currency:"BRL" });
  }
  function parseBRLMasked(v){
    const s = String(v || "")
      .replace(/\s/g,"")
      .replace("R$","")
      .replace(/\./g,"")
      .replace(",",".")
      .replace(/[^\d.-]/g,"");
    const n = Number(s);
    return Number.isFinite(n) ? n : NaN;
  }
  function attachMoneyMask(ids){
    ids.forEach(id=>{
      const el = $(id);
      if(!el) return;
      el.addEventListener("input", () => {
        const digits = onlyDigits(el.value);
        el.value = formatBRLFromDigits(digits);
      });
      el.addEventListener("blur", () => {
        const digits = onlyDigits(el.value);
        el.value = formatBRLFromDigits(digits);
      });
    });
  }

  let mode = "sustain";
  let chart;

  function resetResults(){
    $("HealthEmoji").textContent = "‚Äî";
    $("HealthTitle").textContent = "Aguardando an√°lise";
    $("HealthDesc").textContent = "Preencha os campos e clique em ‚ÄúAnalisar cen√°rio‚Äù.";
    $("Metric1Value").textContent = "‚Äî";
    $("Metric2Value").textContent = "‚Äî";
    $("Metric3Value").textContent = "‚Äî";
    $("Why").textContent = "Assim que voc√™ rodar a an√°lise, aqui aparece a explica√ß√£o do cen√°rio.";
    $("How").textContent = "‚Äî";

    $("InflBlock").classList.add("hidden");
    $("InflRefTag").textContent = "‚Äî";
    $("InflLineFinal").textContent = "‚Äî";
    $("RealFinal").textContent = "‚Äî";

    $("TableBody").innerHTML = `<tr><td class="px-4 py-6 text-black/45" colspan="4">Rode uma an√°lise para ver a tabela.</td></tr>`;
    $("SaveBtn").disabled = true;
    $("SaveBtn").className = "rounded-xl border border-black/5 bg-black/5 px-3 py-2 text-[13px] font-medium text-black/30 cursor-not-allowed";
    $("SaveBox").classList.add("hidden");
    if(chart){ chart.destroy(); chart = null; }
    renderEmptyChart();
  }

  function setMode(next){
    mode = next;

    if(mode === "build"){
      $("btnBuild").className = "rounded-lg px-4 py-2 text-[13px] font-medium transition bg-[var(--green)] text-white";
      $("btnSustain").className = "rounded-lg px-4 py-2 text-[13px] font-medium transition text-black/70 hover:bg-black/5";
      $("cfLabel").textContent = "Aporte";
      $("Metric1Title").textContent = "Aporte anual (equivalente)";
      $("Metric1Sub").textContent = "Aporte mensal √ó 12";
      $("Metric3Title").textContent = "Patrim√¥nio final (base)";
      $("Metric3Sub").textContent = "No fim do horizonte";
      $("TableCFHead").textContent = "Aporte";
      $("StepFields").classList.add("hidden");
    } else {
      $("btnBuild").className = "rounded-lg px-4 py-2 text-[13px] font-medium transition text-black/70 hover:bg-black/5";
      $("btnSustain").className = "rounded-lg px-4 py-2 text-[13px] font-medium transition bg-[var(--green)] text-white";
      $("cfLabel").textContent = "Retirada";
      $("Metric1Title").textContent = "Taxa de retirada (inicial)";
      $("Metric1Sub").textContent = "Retirada anual / patrim√¥nio";
      $("Metric3Title").textContent = "Esgotamento (base)";
      $("Metric3Sub").textContent = "Se ocorrer no horizonte";
      $("TableCFHead").textContent = "Retirada";
      $("StepFields").classList.remove("hidden");
    }
    resetResults();
  }

  function simulateScenario({P0, cfMonthlyBase, cfY2, cfY3, rMonthly, months, mode}){
    let P = P0;
    let exhaustedAtMonth = null;
    const yearly = [];

    function stepBaseForMonth(m){
      if(mode !== "sustain") return cfMonthlyBase;
      const year = Math.ceil(m / 12);
      let stepBase = cfMonthlyBase;
      if(year === 2 && cfY2 != null) stepBase = cfY2;
      if(year >= 3 && cfY3 != null) stepBase = cfY3;
      return stepBase;
    }

    for(let m=1; m<=months; m++){
      const flow = stepBaseForMonth(m);

      P = P * (1 + rMonthly);
      if(mode === "sustain") P = P - flow;
      else P = P + flow;

      if(P <= 0 && exhaustedAtMonth === null){
        exhaustedAtMonth = m;
        P = 0;
      }

      if(m % 12 === 0){
        let sum = 0;
        const start = m - 11;
        for(let k=start; k<=m; k++) sum += stepBaseForMonth(k);
        yearly.push({ pEnd: P, cashflowYear: sum, exhausted: exhaustedAtMonth !== null && exhaustedAtMonth <= m });
      }
    }
    return { yearly, exhaustedAtMonth };
  }

  function computeHealth({exhaustedYearBase, pFinal, inflFinal}){
    if(exhaustedYearBase) return "üî¥";
    if(!Number.isFinite(inflFinal)) return "üü°"; // no inflation ref -> neutral
    if(pFinal >= inflFinal * 1.02) return "üü¢";
    if(pFinal >= inflFinal * 0.98) return "üü°";
    return "üî¥";
  }

  function renderEmptyChart(){
    const ctx = $("Chart").getContext("2d");
    chart = new Chart(ctx, {
      type: "line",
      data: { labels:[""], datasets:[{ label:"Base", data:[0], borderColor:"#1F4D3A", borderWidth:2, pointRadius:0, tension:0.25 }] },
      options: {
        responsive:true, maintainAspectRatio:false,
        plugins:{ legend:{display:false}, tooltip:{enabled:false} },
        scales:{ x:{grid:{display:false},ticks:{display:false}}, y:{grid:{color:"rgba(0,0,0,0.06)"},ticks:{display:false}} }
      }
    });
  }

  function renderChart(points, showInfl){
    const labels = points.map(p => `Ano ${p.year}`);
    const cons = points.map(p => p.conservador);
    const base = points.map(p => p.base);
    const opt  = points.map(p => p.otimista);
    const infl = points.map(p => p.inflacao);

    const datasets = [
      { label:"Conservador", data:cons, borderColor:"#6B7280", borderWidth:2, pointRadius:0, tension:0.25 },
      { label:"Base", data:base, borderColor:"#1F4D3A", borderWidth:2.5, pointRadius:0, tension:0.25 },
      { label:"Otimista", data:opt, borderColor:"#111827", borderWidth:2, pointRadius:0, tension:0.25 }
    ];

    if(showInfl && infl.some(v => Number.isFinite(v))){
      datasets.push({ label:"Infla√ß√£o (refer√™ncia)", data:infl, borderColor:"#9CA3AF", borderWidth:2, pointRadius:0, tension:0.25, borderDash:[6,6] });
    }

    if(chart) chart.destroy();
    const ctx = $("Chart").getContext("2d");
    chart = new Chart(ctx, {
      type:"line",
      data:{ labels, datasets },
      options:{
        responsive:true, maintainAspectRatio:false,
        plugins:{ tooltip:{ callbacks:{ label:(c)=> `${c.dataset.label}: ${fmtBRL(c.parsed.y)}` } } },
        scales:{
          x:{ grid:{display:false}, ticks:{color:"rgba(0,0,0,.55)", maxRotation:0, autoSkip:true} },
          y:{ grid:{color:"rgba(0,0,0,0.06)"},
            ticks:{ color:"rgba(0,0,0,.55)", callback:(v)=>{ const n=Number(v);
              if(n>=1_000_000) return (n/1_000_000).toFixed(1)+"M";
              if(n>=1_000) return Math.round(n/1_000)+"k";
              return n; } } }
        }
      }
    });
  }

  function run(){
    const P0 = parseBRLMasked($("P0").value);
    const cfRaw = parseBRLMasked($("CF").value);
    const cfPeriod = $("CFPeriod").value;

    const yearsRaw = parseInt($("Years").value || "0", 10);
    const years = clamp(yearsRaw, 1, 40);

    const RconsPct = parseNumberBR($("Rcons").value);
    const RbasePct = parseNumberBR($("Rbase").value);
    const RoptPct  = parseNumberBR($("Ropt").value);

    const inflRefPct = parseNumberBR($("InflRef").value);
    const hasInfl = Number.isFinite(inflRefPct) && inflRefPct > 0;
    const inflRef = hasInfl ? inflRefPct/100 : NaN;
    const showInfl = $("ShowInfl").checked && hasInfl;

    const cfY2Raw = parseBRLMasked(($("CFY2")?.value || "").trim());
    const cfY3Raw = parseBRLMasked(($("CFY3")?.value || "").trim());
    const cfY2 = (mode==="sustain" && Number.isFinite(cfY2Raw) && cfY2Raw > 0) ? cfY2Raw : null;
    const cfY3 = (mode==="sustain" && Number.isFinite(cfY3Raw) && cfY3Raw > 0) ? cfY3Raw : null;

    // validations
    if(!Number.isFinite(P0) || P0 <= 0) return alert("Preencha o patrim√¥nio.");
    if(!Number.isFinite(cfRaw) || cfRaw < 0) return alert(mode==="sustain" ? "Preencha a retirada." : "Preencha o aporte.");
    if(!Number.isFinite(RconsPct) || !Number.isFinite(RbasePct) || !Number.isFinite(RoptPct)) return alert("Preencha Conservador/Base/Otimista (% a.a.).");
    if(yearsRaw < 1) return alert("Preencha o horizonte (anos).");

    const months = years * 12;
    const cfMonthlyBase = (cfPeriod === "anual") ? (cfRaw/12) : cfRaw;

    const scenarios = [
      { key:"conservador", Raa: RconsPct/100 },
      { key:"base",       Raa: RbasePct/100 },
      { key:"otimista",   Raa: RoptPct/100 }
    ];

    const results = {};
    scenarios.forEach(s=>{
      const rMonthly = annualToMonthlyEq(s.Raa);
      results[s.key] = simulateScenario({ P0, cfMonthlyBase, cfY2, cfY3, rMonthly, months, mode });
    });

    const yBase = results.base.yearly;
    const yCons = results.conservador.yearly;
    const yOpt  = results.otimista.yearly;

    const rows = [];
    const points = [];

    for(let y=1; y<=years; y++){
      const pBase = yBase[y-1]?.pEnd ?? 0;
      const pCons = yCons[y-1]?.pEnd ?? 0;
      const pOpt  = yOpt[y-1]?.pEnd  ?? 0;
      const cashflowYear = yBase[y-1]?.cashflowYear ?? 0;
      const inflLine = hasInfl ? (P0 * Math.pow(1 + inflRef, y)) : NaN;

      let health = "üü°";
      if(yBase[y-1]?.exhausted) health = "üî¥";
      else if(hasInfl){
        if(pBase >= inflLine * 1.02) health = "üü¢";
        else if(pBase >= inflLine * 0.98) health = "üü°";
        else health = "üî¥";
      }

      rows.push({ year:y, pBase, cashflowYear, health, inflLine });
      points.push({ year:y, conservador:pCons, base:pBase, otimista:pOpt, inflacao: inflLine });
    }

    const exhaustedAtMonthBase = results.base.exhaustedAtMonth;
    const exhaustedYearBase = exhaustedAtMonthBase ? Math.ceil(exhaustedAtMonthBase/12) : null;

    const pFinal = rows[rows.length-1]?.pBase ?? 0;
    const inflFinal = rows[rows.length-1]?.inflLine ?? NaN;
    const overall = computeHealth({ exhaustedYearBase, pFinal, inflFinal });

    // metrics
    $("Metric2Value").textContent = `${years} anos`;

    if(mode==="sustain"){
      const withdrawRate = (cfMonthlyBase*12)/P0;
      $("Metric1Value").textContent = fmtPct(withdrawRate);
      $("Metric3Value").textContent = exhaustedYearBase ? `Ano ${exhaustedYearBase}` : `> ${years} anos`;
    } else {
      $("Metric1Value").textContent = fmtBRL(cfMonthlyBase*12);
      $("Metric3Value").textContent = fmtBRL(pFinal);
    }

    // header
    $("HealthEmoji").textContent = overall;
    $("HealthTitle").textContent = overall==="üü¢" ? "Saud√°vel" : overall==="üü°" ? "Aten√ß√£o" : "Risco";
    $("HealthDesc").textContent =
      !hasInfl
        ? (overall==="üî¥" ? "H√° risco de esgotamento no cen√°rio base." : "Sem infla√ß√£o de refer√™ncia: diagn√≥stico neutro (opcional).")
        : (overall==="üü¢" ? "Acima da linha de infla√ß√£o (poder de compra preservado)." :
           overall==="üü°" ? "Pr√≥ximo da linha de infla√ß√£o (poder de compra no limite)." :
           "Abaixo da linha de infla√ß√£o / ou risco de esgotamento.");

    // inflation block
    if(hasInfl){
      $("InflBlock").classList.remove("hidden");
      $("InflRefTag").textContent = `${inflRefPct.toLocaleString("pt-BR",{maximumFractionDigits:2})}% a.a.`;
      $("InflLineFinal").textContent = fmtBRL(inflFinal);
      const realFinal = pFinal / Math.pow(1 + inflRef, years);
      $("RealFinal").textContent = fmtBRL(realFinal);
    } else {
      $("InflBlock").classList.add("hidden");
    }

    // explanation
    if(overall==="üü¢"){
      $("Why").innerHTML = `Cen√°rio saud√°vel: o patrim√¥nio final (<b>${fmtBRL(pFinal)}</b>) est√° s√≥lido no horizonte.`;
      if(hasInfl) $("Why").innerHTML += ` Ele ficou acima do m√≠nimo para manter poder de compra (<b>${fmtBRL(inflFinal)}</b>).`;
    } else if(overall==="üü°"){
      $("Why").innerHTML = `Cen√°rio no limite: o patrim√¥nio n√£o mostra folga clara no horizonte.`;
      if(hasInfl) $("Why").innerHTML += ` Ele ficou pr√≥ximo da linha de infla√ß√£o (<b>${fmtBRL(inflFinal)}</b>).`;
      else $("Why").innerHTML += ` Se quiser comparar poder de compra, preencha a infla√ß√£o (opcional).`;
    } else {
      $("Why").innerHTML = exhaustedYearBase
        ? `Cen√°rio de risco: no cen√°rio base, h√° chance de esgotamento por volta do <b>ano ${exhaustedYearBase}</b>.`
        : `Cen√°rio de risco: o patrim√¥nio final ficou abaixo do n√≠vel desej√°vel no horizonte.`;
      if(hasInfl && !exhaustedYearBase) $("Why").innerHTML += ` A linha de infla√ß√£o no final √© <b>${fmtBRL(inflFinal)}</b>.`;
    }

    if(mode==="sustain" && (cfY2 || cfY3)){
      const parts = [];
      if(cfY2) parts.push(`2¬∫ ano: ${fmtBRL(cfY2)}/m√™s`);
      if(cfY3) parts.push(`3¬∫ ano+: ${fmtBRL(cfY3)}/m√™s`);
      $("Why").innerHTML += `<div class="mt-2 text-[12px] text-black/60">Patamares: ${parts.join(" ‚Ä¢ ")}.</div>`;
    }

    // how
    $("How").innerHTML = `
      <div><b>Retorno mensal equivalente:</b> r = (1 + R<sub>aa</sub>)<sup>1/12</sup> ‚àí 1</div>
      <div class="mt-2"><b>Regra mensal:</b> primeiro rende, depois aplica o fluxo</div>
      <div>P<sub>t+1</sub> = P<sub>t</sub>(1+r) ${mode==="sustain" ? "‚àí" : "+"} Fluxo(t)</div>
      <div class="mt-2"><b>Cen√°rios:</b> voc√™ definiu Conservador/Base/Otimista.</div>
      <div class="mt-2"><b>Infla√ß√£o (opcional):</b> n√£o altera o fluxo; s√≥ cria a linha P*(t)=P0(1+œÄ)^t para compara√ß√£o.</div>
    `;

    // table
    $("TableBody").innerHTML = rows.map(r => `
      <tr class="border-b border-black/5">
        <td class="px-4 py-2">${r.year}</td>
        <td class="px-4 py-2">${fmtBRL(r.pBase)}</td>
        <td class="px-4 py-2">${fmtBRL(r.cashflowYear)}</td>
        <td class="px-4 py-2">${r.health}</td>
      </tr>
    `).join("");

    // chart
    renderChart(points, showInfl);

    // enable save
    $("SaveBtn").disabled = false;
    $("SaveBtn").className = "rounded-xl border border-black/10 bg-white px-3 py-2 text-[13px] font-medium transition hover:bg-black/5";
  }

  // save box
  $("SaveBtn").addEventListener("click", () => $("SaveBox").classList.toggle("hidden"));
  $("SaveForm").addEventListener("submit", (e) => {
    e.preventDefault();
    alert("Resumo enviado (MVP).");
    $("SaveBox").classList.add("hidden");
    $("Email").value = "";
  });

  // events
  $("Run").addEventListener("click", run);
  $("btnBuild").addEventListener("click", () => setMode("build"));
  $("btnSustain").addEventListener("click", () => setMode("sustain"));

  // init
  attachMoneyMask(["P0","CF","CFY2","CFY3"]);
  renderEmptyChart();
  $("StepFields").classList.remove("hidden");
</script>
</body>
</html>
```

